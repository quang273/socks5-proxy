#!/bin/bash
set -euo pipefail

# ======================== CHECK BOT/ID INPUT =========================
if [ $# -lt 7 ]; then
    echo "Usage: $0 PORT PASSWORD ALLOW_IP ENABLE_TELEGRAM BOT_TOKEN USER_ID PROXY_USERNAME"
    exit 1
fi

PORT="$1"
PASSWORD="$2"
ALLOW_IP="$3"
ENABLE_TELEGRAM="$4"
BOT_TOKEN="$5"
USER_ID="$6"
PROXY_USERNAME="$7"

sendTG() {
    if [ "$ENABLE_TELEGRAM" -eq 1 ]; then
        curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
        -d chat_id="${USER_ID}" \
        -d text="${1}" >/dev/null
    fi
}

# ======================== AZURE CONFIG ===============================
RESOURCE_GROUP="proxy-japan"
LOCATION="japaneast"
VM_SIZE="Standard_B1s"
IMAGE="Ubuntu2404"
ADMIN_USER="azureuser"
VM_COUNT=6
RESULT_FILE="/tmp/proxy_result_${RANDOM}.txt"
rm -f "$RESULT_FILE"

# ======================== CREATE RESOURCE GROUP ======================
az group show --name "$RESOURCE_GROUP" >/dev/null 2>&1 || {
    sendTG "âš™ï¸ Creating Resource Group $RESOURCE_GROUP at $LOCATION..."
    az group create --name "$RESOURCE_GROUP" --location "$LOCATION" >/dev/null
}

# ======================== CREATE NSG ================================
NSG_NAME="proxy-nsg"
az network nsg show --resource-group "$RESOURCE_GROUP" --name "$NSG_NAME" >/dev/null 2>&1 || {
    sendTG "ðŸ”’ Creating NSG rule for proxy port $PORT..."
    az network nsg create --resource-group "$RESOURCE_GROUP" --name "$NSG_NAME" >/dev/null
    az network nsg rule create \
        --resource-group "$RESOURCE_GROUP" \
        --nsg-name "$NSG_NAME" \
        --name AllowProxyPort \
        --protocol Tcp \
        --priority 1001 \
        --destination-port-ranges "$PORT" \
        --access Allow \
        --source-address-prefixes "$ALLOW_IP" >/dev/null
}

# ======================== DEPLOY 6 VMs ===============================
for i in $(seq 1 $VM_COUNT); do
    VM_NAME="proxy-jp-$i"
    IP_NAME="proxy-ip-$i"

    sendTG "ðŸš€ Deploying VM $VM_NAME..."

    az network public-ip create \
        --resource-group "$RESOURCE_GROUP" \
        --name "$IP_NAME" \
        --sku Standard --allocation-method static >/dev/null

    az vm create \
        --resource-group "$RESOURCE_GROUP" \
        --name "$VM_NAME" \
        --image "$IMAGE" \
        --size "$VM_SIZE" \
        --admin-username "$ADMIN_USER" \
        --generate-ssh-keys \
        --public-ip-address "$IP_NAME" \
        --nsg "$NSG_NAME" >/dev/null

    PUBLIC_IP=$(az network public-ip show --resource-group "$RESOURCE_GROUP" --name "$IP_NAME" --query "ipAddress" -o tsv)

    # ================== INSTALL DANTE + SETUP PROXY ==================
    sendTG "âš™ï¸ Installing proxy on $PUBLIC_IP..."

    az vm run-command invoke \
        --resource-group "$RESOURCE_GROUP" \
        --name "$VM_NAME" \
        --command-id RunShellScript \
        --scripts "sudo apt update && sudo apt install -y dante-server && sudo bash -c 'cat >/etc/danted.conf <<EOF
logoutput: /var/log/danted.log
internal: ens33 port = $PORT
external: ens33
method: username
user.notprivileged: nobody
client pass {
        from: $ALLOW_IP
        to: 0.0.0.0/0
        log: connect disconnect
}
socks pass {
        from: $ALLOW_IP
        to: 0.0.0.0/0
        log: connect disconnect
}
EOF'
useradd -m $PROXY_USERNAME || true
echo "$PROXY_USERNAME:$PASSWORD" | chpasswd
systemctl restart danted" >/dev/null

    echo "$PUBLIC_IP:$PORT:$PROXY_USERNAME:$PASSWORD" >> "$RESULT_FILE"
done

# ======================== SEND RESULT ===============================
if [ -f "$RESULT_FILE" ]; then
    PROXY_LIST=$(cat "$RESULT_FILE")
    sendTG "ðŸŽ‰ *Táº¡o 6 proxy Nháº­t Báº£n thÃ nh cÃ´ng!*

\`\n$PROXY_LIST\n\`"
fi
